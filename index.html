<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¶œì„ë¶€ PDF ìƒì„±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
            margin: 0;
            padding: 40px 20px;
            color: #333;
        }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 40px; font-size: 2em; letter-spacing: 1px; }
        form { max-width: 750px; margin: 0 auto 40px auto; background-color: #fff; padding: 25px 35px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: transform 0.3s; }
        form:hover { transform: translateY(-3px); }
        label { font-weight: 700; margin-right: 10px; }
        select { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; transition: border 0.3s, box-shadow 0.3s; }
        select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 8px rgba(52,152,219,0.3); }
        button { padding: 10px 22px; margin-top: 20px; margin-right: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; }
        #previewBtn { background-color: #3498db; color: #fff; }
        #previewBtn:hover { background-color: #2980b9; transform: translateY(-2px); }
        button[type="submit"] { background-color: #2ecc71; color: #fff; }
        button[type="submit"]:hover { background-color: #27ae60; transform: translateY(-2px); }
        #previewArea { max-width: 900px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 20px rgba(0,0,0,0.08); font-size: 14px; }
        th, td { padding: 14px 16px; text-align: center; transition: background 0.3s; }
        th { background: linear-gradient(90deg, #3498db, #2980b9); color: #fff; font-weight: 700; cursor: pointer; user-select: none; }
        th:hover { background: linear-gradient(90deg, #2980b9, #3498db); }
        tr:nth-child(even) { background-color: #f7f9fc; }
        tr:nth-child(odd) { background-color: #ffffff; }
        tr:hover { background-color: #d6eaf8; }
        @media (max-width: 768px) { table, th, td { font-size: 13px; } button { padding: 8px 16px; } }
        @media (max-width: 480px) { h1 { font-size: 1.5em; } form { padding: 20px 15px; } table { font-size: 12px; } }
    </style>
</head>
<body>

<h1>ì¶œì„ë¶€ ìƒì„±</h1>

<form method="POST">
    <!-- í•™ê³¼ ì„ íƒ -->
    <label>í•™ê³¼ í•„í„°:</label>
    <select id="dept_filter">
        <option value="">-- ì „ì²´ --</option>
        {% for dept in sections|map(attribute=7)|unique %}
            <option value="{{ dept }}">{{ dept }}</option>
        {% endfor %}
    </select>

    <br><br>
    <!-- ê³¼ëª© ì„ íƒ -->
    <label>ê³¼ëª© ì„ íƒ:</label>
    <select id="course_select">
        <option value="">-- ì„ íƒ --</option>
    </select>

    <br><br>
    <!-- Section ì„ íƒ -->
    <label>Section ì„ íƒ:</label>
    <select id="section_select" required>
        <option value="">-- ì„ íƒ --</option>
    </select>

    <!-- hidden inputs -->
    <input type="hidden" name="course_id" id="course_id">
    <input type="hidden" name="sec_id" id="sec_id">
    <input type="hidden" name="semester" id="semester">
    <input type="hidden" name="year" id="year">
    <input type="hidden" name="students_json" id="students_json">

    <br><br>
    <button type="button" id="previewBtn">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
    <button type="submit">ğŸ“„ PDF ìƒì„±</button>
</form>

<div id="previewArea"></div>

<!-- sections ë°ì´í„° -->
<script id="sections-data" type="application/json">
    {{ sections | tojson | safe }}
</script>

<script>
    const allSections = JSON.parse(document.getElementById('sections-data').textContent);

    const deptFilter = document.getElementById('dept_filter');
    const courseSelect = document.getElementById('course_select');
    const sectionSelect = document.getElementById('section_select');

    let filteredSections = [];

    // 1. í•™ê³¼ ì„ íƒ
    deptFilter.addEventListener('change', () => {
        const dept = deptFilter.value;
        courseSelect.innerHTML = '<option value="">-- ì„ íƒ --</option>';
        sectionSelect.innerHTML = '<option value="">-- ì„ íƒ --</option>';

        filteredSections = allSections.filter(s => !dept || s[7] === dept);

        // ê³¼ëª© ì¤‘ë³µ ì œê±° í›„ ê³¼ëª© ì˜µì…˜ ìƒì„±
        const courses = [...new Set(filteredSections.map(s => s[1]))];
        courses.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.text = c;
            courseSelect.add(opt);
        });
    });

    // 2. ê³¼ëª© ì„ íƒ ì‹œ Section ì˜µì…˜ ìƒì„±
    courseSelect.addEventListener('change', () => {
        const courseName = courseSelect.value;
        sectionSelect.innerHTML = '<option value="">-- ì„ íƒ --</option>';

        if (!courseName) return;

        const sectionsForCourse = filteredSections.filter(s => s[1] === courseName);
        sectionsForCourse.forEach(s => {
            const opt = document.createElement('option');
            opt.value = `${s[0]}|${s[2]}|${s[3]}|${s[4]}`;
            opt.text = `Sec ${s[2]} | ${s[3]} | ${s[4]} | ${s[7]}`;
            opt.dataset.dept = s[7];
            sectionSelect.add(opt);
        });
    });

    // 3. Section ì„ íƒ ì‹œ hidden input ì±„ìš°ê¸°
    sectionSelect.addEventListener('change', function() {
        const [course_id, sec_id, semester, year] = this.value.split('|');
        document.getElementById('course_id').value = course_id;
        document.getElementById('sec_id').value = sec_id;
        document.getElementById('semester').value = semester;
        document.getElementById('year').value = year;
    });

    // -----------------------------
    // ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
    // -----------------------------
    let currentStudents = [];
    let sortDirection = true;

    document.getElementById("previewBtn").addEventListener("click", async () => {
        if (!sectionSelect.value) { alert("ë¨¼ì € Sectionì„ ì„ íƒí•˜ì„¸ìš”."); return; }
        const [course_id, sec_id, semester, year] = sectionSelect.value.split('|');
        const res = await fetch("/preview", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({course_id, sec_id, semester, year})
        });
        const students = await res.json();
        if (!students.length) {
            document.getElementById("previewArea").innerHTML = "<p>ìˆ˜ê°• í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }
        renderPreviewTable(students);
    });

    function renderPreviewTable(students) {
        currentStudents = students;
        let html = `
            <table id="previewTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">í•™ë²ˆ</th>
                        <th onclick="sortTable(1)">ì´ë¦„</th>
                        <th onclick="sortTable(2)">í•™ê³¼</th>
                    </tr>
                </thead>
                <tbody>
        `;
        for (let stu of students) {
            html += `<tr><td>${stu[0]}</td><td>${stu[1]}</td><td>${stu[2]}</td></tr>`;
        }
        html += "</tbody></table>";
        document.getElementById("previewArea").innerHTML = html;
    }

    function sortTable(colIndex) {
        currentStudents.sort((a, b) => {
            if (colIndex === 0) return sortDirection ? Number(a[0]) - Number(b[0]) : Number(b[0]) - Number(a[0]);
            if (a[colIndex] < b[colIndex]) return sortDirection ? -1 : 1;
            if (a[colIndex] > b[colIndex]) return sortDirection ? 1 : -1;
            return 0;
        });
        sortDirection = !sortDirection;
        renderPreviewTable(currentStudents);
    }

    // PDF ìƒì„± ì „ students_json ì„¸íŒ…
    document.querySelector("form").addEventListener("submit", function() {
        const rows = document.querySelectorAll("#previewTable tbody tr");
        let arr = [];
        rows.forEach(r => { arr.push([r.children[0].innerText, r.children[1].innerText, r.children[2].innerText]); });
        document.getElementById("students_json").value = JSON.stringify(arr);
    });

</script>

</body>
</html>
