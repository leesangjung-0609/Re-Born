<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>로그인 / 비밀번호 찾기 (팝업)</title>
  <link href="style.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=SUIT:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

  <div class="top-bar">
    <a href="main.html" class="logo">Re:Born</a>
  </div>

  <div class="login-container" id="loginForm">
    <h2>로그인</h2>
    <label for="loginId">아이디</label>
    <input type="text" id="loginId" placeholder="아이디 입력">
    <label for="loginPw">비밀번호</label>
    <input type="password" id="loginPw" placeholder="비밀번호 입력">
    <button onclick="login()">로그인</button>
    
    <div id="loginMsg" class="error-message content-hidden"></div>

    <div class="toggle">
      계정이 없으신가요? <a href="signup.html"><span>회원가입</span></a><br>
      아이디/비밀번호를 잊으셨나요?
      <span onclick="openModal('findIdModal')">아이디 찾기</span> /
      <span onclick="openModal('findPwModal')">비밀번호 찾기</span>
    </div>
  </div>

  <div id="findIdModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('findIdModal')">&times;</span>
      <h2>아이디 찾기</h2>
      <div id="findIdStep1">
        <label for="findIdEmail">가입한 이메일</label>
        <input type="email" id="findIdEmail" placeholder="가입 시 이메일 입력">
        <button onclick="findIdByEmail()">아이디 찾기</button>
        <div id="findIdMsg" class="error-message content-hidden"></div>
      </div>
      <div id="findIdResult" class="content-hidden">
        <p>고객님의 아이디는 다음과 같습니다.</p>
        <div id="displayId" class="id-display"></div>
        <button onclick="closeModal('findIdModal')">로그인 화면으로 이동</button>
      </div>
    </div>
  </div>

  <div id="findPwModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('findPwModal')">&times;</span>
      <h2>비밀번호 찾기</h2>
      <label for="findPwEmail">가입한 이메일</label>
      <input type="email" id="findPwEmail" placeholder="가입 시 이메일 입력">
      <button onclick="checkEmailForPw()">다음</button>
      <div id="findPwMsg" class="error-message content-hidden"></div>
    </div>
  </div>

  <div id="resetPwModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('resetPwModal')">&times;</span>
      <h2>비밀번호 재설정</h2>
      <label for="oldPw">현재 비밀번호</label>
      <input type="text" id="oldPw" placeholder="현재 비밀번호 입력">
      <label for="newPw">새 비밀번호</label>
      <input type="password" id="newPw" placeholder="새 비밀번호 입력">
      <label for="newPwConfirm">새 비밀번호 확인</label>
      <input type="password" id="newPwConfirm" placeholder="다시 한 번 입력">
      <button onclick="resetPassword()">비밀번호 변경</button>
      <div id="resetMsg"></div>
      <button onclick="closeModal('resetPwModal')" style="margin-top: 10px; background-color: #6c757d;">취소</button>
    </div>
  </div>

  <script>
    const ADMIN_ID = "admin";
    const ADMIN_PW = "1234";

    const loginForm = document.getElementById('loginForm');
    const findIdMsg = document.getElementById('findIdMsg');
    const findIdStep1 = document.getElementById('findIdStep1');
    const findIdResult = document.getElementById('findIdResult');
    const displayId = document.getElementById('displayId');
    const findPwMsg = document.getElementById('findPwMsg');
    const resetMsg = document.getElementById('resetMsg');
    let currentUser = null;

    const findIdModal = document.getElementById('findIdModal');
    const findPwModal = document.getElementById('findPwModal');
    const resetPwModal = document.getElementById('resetPwModal');

    function openModal(modalId) {
      findIdModal.style.display = 'none';
      findPwModal.style.display = 'none';
      resetPwModal.style.display = 'none';

      document.getElementById(modalId).style.display = 'block';

      if (modalId === 'findIdModal') {
        findIdStep1.classList.remove('content-hidden');
        findIdResult.classList.add('content-hidden');
        findIdMsg.classList.add('content-hidden');
        document.getElementById('findIdEmail').value = '';
      }

      if (modalId === 'findPwModal') {
        findPwMsg.classList.add('content-hidden');
        document.getElementById('findPwEmail').value = '';
      }

      if (modalId === 'resetPwModal') {
        resetMsg.textContent = '';
        document.getElementById('newPw').value = '';
        document.getElementById('newPwConfirm').value = '';
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function login() {
      const id = document.getElementById('loginId').value;
      const pw = document.getElementById('loginPw').value;

      const ADMIN_ID = "admin"; // login.html 내에 정의되어 있다고 가정
      const ADMIN_PW = "1234";  // login.html 내에 정의되어 있다고 가정

      const loginMsg = document.getElementById('loginMsg');

      // 1. 관리자 계정 확인
      if (id === ADMIN_ID && pw === ADMIN_PW) {
        // ⭐️⭐️⭐️ 핵심: Local Storage에 로그인 상태와 ID 저장 ⭐️⭐️⭐️
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loggedInUser', id);

        alert(`관리자 ${id}님, 환영합니다!`);
        window.location.href = "main.html"; // 메인 페이지로 이동
        return;
      }

      // 2. 일반 사용자 계정 확인 (Local Storage 이용)
      const userData = JSON.parse(localStorage.getItem('user'));

      if (userData && id === userData.id && pw === userData.pw) {
        // ⭐️⭐️⭐️ 핵심: Local Storage에 로그인 상태와 ID 저장 ⭐️⭐️⭐️
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('loggedInUser', id);

        alert(`환영합니다 ${id}님!`);
        window.location.href = "main.html"; // 메인 페이지로 이동
      } else {
        loginMsg.textContent = "아이디 또는 비밀번호가 올바르지 않습니다.";
        loginMsg.classList.remove('content-hidden');
        //alert("아이디 또는 비밀번호가 올바르지 않습니다.");
        // 실패 시 혹시 모를 이전 정보 삭제
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('loggedInUser');
      }
    }

    function findIdByEmail() {
      const email = document.getElementById('findIdEmail').value;
      const userData = JSON.parse(localStorage.getItem('user'));

      findIdMsg.classList.add('content-hidden');

      if (!email) {
        findIdMsg.textContent = "이메일을 입력해주세요!";
        findIdMsg.classList.remove('content-hidden');
        return;
      }

      if (userData && userData.email === email) {
        displayId.textContent = userData.id;
        findIdStep1.classList.add('content-hidden');
        findIdResult.classList.remove('content-hidden');
      } else {
        findIdMsg.textContent = "등록된 이메일이 없거나, 가입 정보가 일치하지 않습니다.";
        findIdMsg.classList.remove('content-hidden');
      }
    }

    function checkEmailForPw() {
      const email = document.getElementById('findPwEmail').value;
      const userData = JSON.parse(localStorage.getItem('user'));

      findPwMsg.classList.add('content-hidden');

      if (!email) {
        findPwMsg.textContent = "이메일을 입력해주세요!";
        findPwMsg.classList.remove('content-hidden');
        return;
      }

      if (userData && userData.pw === email) {
        currentUser = userData;
        closeModal('findPwModal');
        openModal('resetPwModal');
      } else {
        findPwMsg.textContent = "등록된 이메일이 없습니다.";
        findPwMsg.classList.remove('content-hidden');
      }
    }

    function resetPassword() {
      // 1. 모든 입력값 가져오기
      const oldPw = document.getElementById('oldPw').value;
      const newPw = document.getElementById('newPw').value;
      const confirmPw = document.getElementById('newPwConfirm').value;

      // 2. 메시지 초기화
      resetMsg.textContent = '';
      resetMsg.className = ""; // 이전 스타일 클래스 제거

      // 3. (수정) 모든 칸이 입력되었는지 확인 (oldPw 포함)
      if (!oldPw || !newPw || !confirmPw) {
        resetMsg.textContent = "모든 칸을 입력해주세요!";
        resetMsg.className = "error-message";
        return;
      }

      // 4. (추가) currentUser 객체가 유효한지 확인 (이메일 인증을 통과했는지)
      if (!currentUser) {
        resetMsg.textContent = "사용자 정보가 유실되었습니다. 다시 시도해주세요.";
        resetMsg.className = "error-message";
        return;
      }

      // 5. (⭐️요청사항 추가⭐️) 현재 비밀번호가 일치하는지 확인
      if (oldPw !== currentUser.pw) {
        resetMsg.textContent = "현재 비밀번호가 틀렸습니다.";
        resetMsg.className = "error-message";
        return;
      }

      // 6. (기존 로직) 새 비밀번호와 확인이 일치하는지 확인
      if (newPw !== confirmPw) {
        resetMsg.textContent = "새 비밀번호가 일치하지 않습니다!";
        resetMsg.className = "error-message";
        return;
      }

      // 7. (추가) 현재 비밀번호와 새 비밀번호가 같은지 확인
      if (oldPw === newPw) {
        resetMsg.textContent = "현재 비밀번호와 동일한 비밀번호로 변경할 수 없습니다.";
        resetMsg.className = "error-message";
        return;
      }

      // 8. (기존 로직) LocalStorage에서 정보 업데이트
      let userData = JSON.parse(localStorage.getItem('user'));

      if (userData && currentUser && userData.id === currentUser.id) {
        userData.pw = newPw; // 새 비밀번호로 업데이트
        localStorage.setItem('user', JSON.stringify(userData)); // 저장

        resetMsg.textContent = "✅ 비밀번호가 성공적으로 변경되었습니다!";
        resetMsg.className = "success-message";

        // 2초 후 모달 닫기
        setTimeout(() => closeModal('resetPwModal'), 2000);
      } else {
        // 이메일 인증(currentUser)은 통과했으나, 중간에 localStorage 정보가 바뀐 경우
        resetMsg.textContent = "사용자 정보를 찾을 수 없습니다.";
        resetMsg.className = "error-message";
      }
    }

    // ... (다른 스크립트 함수들) ...
    // login(), openModal(), closeModal(), findIdByEmail(), checkEmailForPw()

  </script>

</body>

</html>
